<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Card Pop-out System</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        /* ポップアウト画像の設定 */
        #key-card {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            max-height: 80vh; opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        #key-card.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        
        /* 操作パネル（OBSでは映らないよう調整） */
        #controller { background: rgba(0,0,0,0.8); color: white; padding: 20px; position: absolute; z-index: 100; }
        .obs-hide { display: none; } /* OBSソースとして読み込む時はURLに ?mode=obs をつける */
    </style>
</head>
<body>

    <img id="key-card" src="">

    <div id="controller">
        <h3>カード演出コントローラー</h3>
        <p>あなたのID: <span id="my-id">接続中...</span></p>
        <hr>
        <input type="text" id="target-id" placeholder="接続先IDを入力">
        <button onclick="connectToPeer()">1. 配信PCへ接続</button>
        <br><br>
        <button onclick="sendCard('card1.png')">カード1表示</button>
        <button onclick="sendCard('card2.png')">カード2表示</button>
        <button onclick="hideCard()">非表示</button>
    </div>

    <script>
        const peer = new Peer(); // Peerオブジェクトの作成
        let conn;
        const cardImg = document.getElementById('key-card');
        const urlParams = new URLSearchParams(window.location.search);

        // OBSモードなら操作パネルを隠す
        if (urlParams.get('mode') === 'obs') {
            document.getElementById('controller').classList.add('obs-hide');
        }

        // 自分のIDが表示されたら
        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
            console.log('My ID:', id);
        });

        // 接続を受けた時（表示側の処理）
        peer.on('connection', (c) => {
            conn = c;
            conn.on('data', (data) => {
                if (data.action === 'show') {
                    cardImg.src = data.url;
                    cardImg.classList.add('show');
                } else {
                    cardImg.classList.remove('show');
                }
            });
        });

        // 接続する（操作側の処理）
        function connectToPeer() {
            const targetId = document.getElementById('target-id').value;
            conn = peer.connect(targetId);
            conn.on('open', () => alert('接続完了！'));
        }

        function sendCard(url) {
            if(conn) conn.send({ action: 'show', url: url });
        }

        function hideCard() {
            if(conn) conn.send({ action: 'hide' });
        }
    </script>
</body>
</html>